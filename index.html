<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PEGedit</title>
    
    
    <!-- Bootstrap -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" />
    
    <!-- ACE editor -->
     <script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js" type="text/javascript"></script>	
    <!-- PEG.js -->
    <script src="./js/peg-0.8.0.js" type="text/javascript"></script>
    <!--jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    
    <script type="text/javascript">
        var parser;
        var treeData;
        var changeSize = function(target, delta) {
            target.setOption('fontSize', target.getOption('fontSize') + delta);
        };

        $('document').ready( function() {
            // Create the PEG editor
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/monokai");
            editor.getSession().setMode("ace/mode/javascript");
            
            // No static JS analysis
            editor.setOption("useWorker", false);
            
            // Personal preferences:
            editor.setOption("tabSize", 2);
            editor.setOption('scrollPastEnd',100);

            // Store retrieve text
            editor.setValue(localStorage["grammar"]);
            if (editor.getValue !== "") {
              $('#build_parser_btn').click();
            }            

            editor.getSession().on("change", function() {
                localStorage.setItem("grammar", editor.getValue());
                $('#build_parser_btn').click();
            });

            // Resize editor
            $('#editor').css("height", window.innerHeight);
            editor.resize();

            // Create parse string editor
            output = ace.edit("output");
            output.setOption("useWorker", false);
            output.setValue(localStorage["source"]);
            output.getSession().on('change', function() {
                localStorage.setItem("source", output.getValue());
                $('#parse_btn').click();
            });

            $('#output').css('height', window.innerHeight / 2);
            output.resize();
            $('#build_parser_btn').click( function() {
                try {
                    editor.getSession().clearAnnotations();
                    parser = PEG.buildParser(editor.getValue());
                    $('.alert-warning').remove();
                } catch(exn) {
                  $('#bottom_right').html('<div class="alert alert-warning" role="alert">Grammar Error: '+ exn.message +'</div>');
                  console.log(exn);
                  //if (!editor.getSession().$annotations) {
                    editor.getSession().$annotations = [];
                  //}

                  var myAnno = {
                    "column": exn['column'],
                    "row": exn['line'] - 1,
                    "type": "error",
                    "raw": exn['message'],
                    "text": exn['message']
                  };
                
                  editor.getSession().$annotations.push(myAnno);
                  editor.getSession().setAnnotations(editor.getSession().$annotations);
                } // catch(exn)      
                   
                
            });

            $('#parse_btn').click( function() {
              // If a parser has been built:
              if (parser) {
                
                // Try to parse:
                try {
                    result = parser.parse(output.getValue());
                    treeData = result;
                    doTree();
                
                // Log any parse errors in the console:                    
                } catch(e) {
                  $('#bottom_right').html('<div class="alert alert-danger" role="alert">Parse Error: '+ e.message +'</div>');
                    console.error(e);
                }
              }
            });

            $('#zoom_in_btn').click( function() {
                changeSize(editor, 2);
                changeSize(output, 2);
        
            });
            $('#zoom_out_btn').click( function() {
                changeSize(editor, -2);
                changeSize(output, -2);
            })
            $(output).focus( function() {
                if (editor.getValue()) {
                    $('#build_parser_btn').click();
                }
            });
        });
    </script>

    <style type="text/css">
		body {
            background-color: white;
            overflow: hidden !important;
        }
        #container {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        #left {
          position: absolute;
          top: 0;
          right: 50%;
          left: 0;
          bottom: 0;
        }
        #right {
          position: absolute;
          top:  0;
          right: 0;
          bottom: 0;

          left: 50%;
        }
        #top_right {
          position: absolute;
          top: 0;
          right: 0;
          left: 0;
          bottom: 50%;

        }
        #bottom_right {
          position: absolute;
          border: 1px solid black;
          top: 51%;
          right: 0;
          bottom: 0;
          left: 0;
        }
        svg {
            pointer-events: all;
        }
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node text { font: 12px sans-serif; }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
    </style>  
    </head>

    <body>
      <div id="container">
        <!-- toolbars -->
        <div id="toolbar" class="">
            
            <button id="build_parser_btn" type="button" class="btn btn-default" aria-label="Left Align">
                <span class="glyphicon glyphicon-ok" aria-hidden="true">&nbsp;Build Parser</span>
            </button>

            <button id="zoom_in_btn" type="button" class="btn btn-default" aria-label="Left Align">
                <span class="glyphicon glyphicon-zoom-in" aria-hidden="true">&nbsp;Zoom In</span>
            </button> 
            <button id="zoom_out_btn" type="button" class="btn btn-default" aria-label="Left Align">
                <span class="glyphicon glyphicon-zoom-out" aria-hidden="true">&nbsp;Zoom Out</span>
            </button> 
        </div>

        <div class="">
            <button id="parse_btn" type="button" class="btn btn-default" aria-label="Left Align">
                <span class="glyphicon glyphicon-play" aria-hidden="true">&nbsp;Parse</span>
             </button> 
         </div>


        <!-- Main layout -->        
        <div id="left">
            <div id="editor"></div>
        </div>
        
        <div id="right">
            <div id="top_right">
                <div id="output"></div>
            </div>
            <div id="bottom_right">
                <div id="tree"></div>
            </div>
        </div>
        
        
      </div>
    <!-- Include all compiled plugins (below), or include individual files as needed -->    
        <script src="./js/d3.min.js" type="text/javascript"></script>
        <script>
          function doTree() {
            $('#bottom_right').html('');
            // ************** Generate the tree diagram  *****************
            var margin = {top: 80, right: 120, bottom: 20, left: 120},
              width = 960 - margin.right - margin.left,
              height = 500 - margin.top - margin.bottom;
              
            var i = 0;

            var tree = d3.layout.tree()
              .size([height, width]);

            var diagonal = d3.svg.diagonal()
              .projection(function(d) { return [d.x, d.y]; });

            var svg = d3.select("#bottom_right").append("svg")
              .attr("width", width + margin.right + margin.left)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top +")")
                .call(d3.behavior.zoom().scaleExtent([0.5,10]).on("zoom", zoom))
              .append("g");
              
            root = treeData[0];
              
            update(root);

            function update(source) {

              // Compute the new tree layout.
              var nodes = tree.nodes(root).reverse(),
                links = tree.links(nodes);

              // Normalize for fixed-depth.
              nodes.forEach(function(d) { d.y = d.depth * 50; });

              // Declare the nodesâ€¦
              var node = svg.selectAll("g.node")
                .data(nodes, function(d) { return d.id || (d.id = ++i); });

              // Enter the nodes.
              var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", function(d) { 
                  return "translate(" + d.x + "," + d.y + ")"; });

              nodeEnter.append("circle")
                .attr("r", 10)
                .style("fill", "#fff");

              nodeEnter.append("text")
                .attr("y", function(d) { 
                  return d.children || d._children ? -18 : 18; })
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .text(function(d) { return d.name; })
                .style("fill-opacity", 1);

              // Declare the linksâ€¦
              var link = svg.selectAll("path.link")
                .data(links, function(d) { return d.target.id; });

              // Enter the links.
              link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", diagonal);

            }
            // zoom and pan
            // var zoom = d3.behavior.zoom()
            // .on("zoom",function() {
            //     g.attr("transform","translate("+ 
            //         d3.event.translate.join(",")+")scale("+d3.event.scale+")");
            //     g.selectAll("path")  
            //         .attr("d", path.projection(projection)); 
            // });

            // svg.call(zoom)
            function zoom() {
              svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            }

        };
</script>
  </body>
</html>